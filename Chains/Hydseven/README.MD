``` 
  ___ ___ ___ ___ ______   _______ _______ ___ ___ _______ ______  
 |   Y   |   Y   |   _  \ |   _   |   _   |   Y   |   _   |   _  \ 
 |.  1   |   1   |.  |   \|   1___|.  1___|.  |   |.  1___|.  |   |
 |.  _   |\_   _/|.  |    |____   |.  __)_|.  |   |.  __)_|.  |   |
 |:  |   | |:  | |:  1    |:  1   |:  1   |:  1   |:  1   |:  |   |
 |::.|:. | |::.| |::.. . /|::.. . |::.. . |\:.. ./|::.. . |::.|   |
 `--- ---' `---' `------' `-------`-------' `---' `-------`--- ---'
Crypto3/Hydseven Windows 10 Firefox RCE/Sandbox Escape Exploit Chain

~ Usage

To execute this chain, you can choose to run it either in offline or online
mode:

Offline - clone this full repository to your machine and modify the
Stage2RunAsLocalFile boolean to be "true", mount the repository to the E:\
drive and open Forrest_Orr_Hydseven_Stage1_64-bit.html in Firefox 65.0.1
64-bit on a Windows 10 x64 OS.


Online - clone this full repository to your machine and run the command
"python -m http.server" from the main/primary directory, then navigate to
http://localhost:8000/Chains/Hydseven/Forrest_Orr_Hydseven_Stage1_64-bit.html
in Firefox 65.0.1 64-bit on a Windows 10 x64 OS.

The end result of executing these steps should be notepad.exe launching from
the parent firefox.exe process.

~

Overview
                                 
The Crypto3/Hydseven exploit chain was a Firefox RCE + sandbox escape which was
used as a 0day code execution technique against Coinbase in 2019. Links containing
the CVE-2019-11707 (RCE) and CVE-2019-11708 (sandbox escape) Firefox exploits 
were emailed to employees at Coinbase in a phishing campaign which targeted
exclusively the Firefox brower on Windows, Linux and macOS systems. 

The end result of the chain was execution of a RAT backdoor, however I have
found no indication that any privilege escalation to NT AUTHORITY\SYSTEM was
ever added to this exploit chain. 

My re-creation of this chain has two components, in the form of HTML pages:

Stage 1 - CVE-2019-11707 is used to gain arbitrary R/W/AddressOf primitives
          which are then used to patch booleans in xul.dll constraining the use
          of privileged IPC calls to the Firefox parent process. Once the child
          content firefox.exe process has been compromised by this stage 1 page
          and xul.dll has been patched, CVE-2019-11708 is invoked an IPC call
          that is made to Prompt:Open in the firefox.exe parent coercing it into
          loading the stage 2 HTML file.
          
Stage 2 - CVE-2019-11707 is used to gain arbitrary R/W/AddressOf primitives
          which are then used (this time within the privileged Firefox parent
          process, not a child/content process as was the case in stage 1) to
          execute a JIT sprayed egg hunter shellcode, which in turn finds a
          secondary arbitrary shellcode payload prefixed by an egg value and
          stored as a Uint8Array, disables DEP on it, and executes it. This
          will result in the firefox.exe parent launching notepad.exe, but can
          be customized to utilize any shellcode.     

~

Links

https://blog.mozilla.org/attack-and-defense/2021/04/27/examining-javascript-inter-process-communication-in-firefox/
https://cryptodaily.co.uk/2019/08/maxs-corner-the-great-coinbase-hack-that-almost-was
https://vigneshsrao.github.io/posts/writeup/
https://doar-e.github.io/blog/2018/11/19/introduction-to-spidermonkey-exploitation/

~

Credits

0vercl0k  - for the original research/analysis of CVE-2019-11708 and reverse
            engineering of xul.dll for "god mode" patching.
            
sherl0ck  - for his writeup on CVE-2019-11707.
```